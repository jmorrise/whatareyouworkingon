<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom styles if needed */
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
        }
        /* Simple transition for button hover */
        button {
            transition: background-color 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl flex space-x-8">

        <div class="flex-grow flex flex-col items-center">
            <h1 class="text-3xl font-bold mb-6 text-center text-red-600">Pomodoro Timer</h1>

            <div class="mb-4 w-full max-w-md">
                <label for="taskInput" class="block text-sm font-medium text-gray-700 mb-1">What are you working on?</label>
                <input type="text" id="taskInput" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="Enter task description...">
            </div>

            <div id="timerDisplay" class="text-6xl font-mono font-bold mb-6 text-gray-800">
                10:00
            </div>

            <button id="controlButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow text-xl">
                Go
            </button>

             <div id="messageBox" class="mt-4 text-center text-green-600 font-semibold h-6"></div>

            </div>

        <div class="w-1/3 border-l border-gray-200 pl-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Completed Tasks</h2>
            <ul id="historyList" class="list-disc list-inside space-y-2 text-gray-600 max-h-80 overflow-y-auto">
                <li class="italic text-gray-400">No tasks completed yet.</li>
            </ul>
        </div>

    </div>

    <script>
        // --- DOM Elements ---
        const taskInput = document.getElementById('taskInput');
        const timerDisplay = document.getElementById('timerDisplay');
        const controlButton = document.getElementById('controlButton');
        const historyList = document.getElementById('historyList');
        const messageBox = document.getElementById('messageBox');

        const workTimerMinutes = 10;

        // --- State Variables ---
        let timerInterval = null; // To store the interval ID
        let remainingTime = workTimerMinutes * 60; // Initial time in seconds
        let currentState = 'idle'; // 'idle', 'working', 'breakPrompt', 'break'
        const WORK_DURATION = workTimerMinutes * 60;
        const BREAK_DURATION = 5 * 60; // 5 minutes in seconds
        const COOKIE_NAME = 'pomodoroHistory';

        // --- Sound Synthesis with Tone.js ---
        // Create a simple synth sound
        const synth = new Tone.Synth().toDestination();
        function playSound() {
            // Ensure Tone.js context is started by user interaction
            Tone.start().then(() => {
                // Play a C4 note for 0.5 seconds
                synth.triggerAttackRelease("C4", "0.5s");
                 console.log("Sound played");
            }).catch(error => {
                console.error("Tone.js start failed:", error);
                // Fallback or message if audio context fails
                showMessage("Could not play sound.");
            });
        }

        // --- Timer Functions ---
        function startTimer(duration) {
            clearInterval(timerInterval); // Clear any existing timer
            remainingTime = duration;
            updateTimerDisplay(); // Show initial time immediately

            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    playSound(); // Play sound when timer ends
                    handleTimerEnd();
                }
            }, 1000); // Update every second
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            // Pad with leading zero if needed
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function handleTimerEnd() {
            if (currentState === 'working') {
                // Work timer finished
                currentState = 'breakPrompt';
                taskInput.disabled = false; // Enable input for editing
                controlButton.textContent = 'Start Break';
                controlButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                controlButton.classList.add('bg-green-500', 'hover:bg-green-600');
                showMessage("Work session complete! Edit task if needed, then start break.");
                taskInput.focus(); // Focus input for easy editing
            } else if (currentState === 'break') {
                // Break timer finished
                resetApp();
                showMessage("Break finished! Ready for the next session.");
            }
        }

        // --- State Management & UI Updates ---
        function resetApp() {
            clearInterval(timerInterval);
            timerInterval = null;
            currentState = 'idle';
            remainingTime = WORK_DURATION;
            taskInput.value = ''; // Clear input
            taskInput.disabled = false;
            controlButton.textContent = 'Go';
            controlButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            controlButton.classList.add('bg-red-500', 'hover:bg-red-600');
            updateTimerDisplay();
            loadTasksFromCookie(); // Refresh history list
            // Clear message after a delay
             setTimeout(() => showMessage(''), 3000);
        }

        function showMessage(message) {
            messageBox.textContent = message;
        }

        // --- Cookie Handling ---
        function saveTaskToCookie(taskDescription) {
            if (!taskDescription) return; // Don't save empty tasks

            let tasks = getTasksFromCookie();
            tasks.push(taskDescription); // Add the new task

            // Store back into cookie (simple implementation, consider size limits)
            // Expires in 30 days
            const expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toUTCString();
            document.cookie = `${COOKIE_NAME}=${encodeURIComponent(JSON.stringify(tasks))}; expires=${expires}; path=/; SameSite=Lax`;

            updateHistoryList(tasks); // Update the UI
        }

        function getTasksFromCookie() {
            const cookies = document.cookie.split('; ');
            console.log(cookies);
            const cookie = cookies.find(row => row.startsWith(COOKIE_NAME + '='));

            if (cookie) {
                try {
                    console.log(cookie);
                    // Decode and parse the JSON string
                    return JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                } catch (e) {
                    console.error("Error parsing cookie:", e);
                    return []; // Return empty array if parsing fails
                }
            } else {
                console.log("No cookies :(");
            }
            return []; // Return empty array if cookie not found
        }

        function loadTasksFromCookie() {
            const tasks = getTasksFromCookie();
            updateHistoryList(tasks);
        }

        // --- History List Update ---
        function updateHistoryList(tasks) {
            historyList.innerHTML = ''; // Clear existing list
            if (tasks.length === 0) {
                 historyList.innerHTML = '<li class="italic text-gray-400">No tasks completed yet.</li>';
            } else {
                tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.textContent = task;
                    historyList.appendChild(li);
                });
            }
        }

        // --- Event Listeners ---
        controlButton.addEventListener('click', () => {
             // Ensure Tone.js is started by user interaction if not already
            if (Tone.context.state !== 'running') {
                Tone.start().then(() => {
                    console.log("Audio context started by button click.");
                    handleButtonClick(); // Proceed with button logic
                }).catch(error => {
                     console.error("Error starting Tone.js context on click:", error);
                     showMessage("Could not initialize audio.");
                });
            } else {
                 handleButtonClick(); // Audio context already running
            }
        });

        function handleButtonClick() {
             showMessage(''); // Clear previous messages

            if (currentState === 'idle') {
                if (!taskInput.value.trim()) {
                    showMessage("Please enter a task description.");
                    taskInput.focus();
                    return;
                }
                // Start working
                currentState = 'working';
                taskInput.disabled = true;
                controlButton.textContent = 'Working...'; // Indicate state
                // Keep red color for working phase
                startTimer(WORK_DURATION);

            } else if (currentState === 'breakPrompt') {
                // Save task and start break
                const currentTask = taskInput.value.trim();
                saveTaskToCookie(currentTask);

                currentState = 'break';
                taskInput.disabled = true; // Disable input during break
                controlButton.textContent = 'On Break...'; // Indicate state
                // Keep green color for break phase
                startTimer(BREAK_DURATION);
            }
            // No action needed if currentState is 'working' or 'break' (button might be visually disabled or just show status)
        }


        // --- Initial Setup ---
        window.onload = () => {
            loadTasksFromCookie(); // Load history when the page loads
            updateTimerDisplay(); // Set initial timer display
             // Add a note about user interaction for sound
            showMessage("Click 'Go' to start the timer (this will also enable sound).");
        };

    </script>
</body>
</html>
